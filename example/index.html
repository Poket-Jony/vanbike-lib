<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VanBike-Lib</title>
</head>
<body>
<div>
    <input id="username" type="text" placeholder="Username">
    <input id="password" type="password" placeholder="Password">
    <button id="retrieveEncryptionData">Retrieve Encryption-Data</button>
    <br><br>
    <input id="encryptionKey" type="text" placeholder="Encryption-Key">
    <input id="userKeyId" type="number" placeholder="User-Key-Id" value="1" min="1">
    <button id="connect">Connect</button>
    <button id="disconnect">Disconnect</button>
</div>
<br><br>
<div>
    <button id="getFirmwareRevision">Get Firmware Revision</button>
    <button id="moduleOn">Module On</button>
    <button id="unlock">Unlock</button>
    <br><br>
    <input id="lightning" type="number" value="0" min="0" max="4">
    <button id="setLightning">Set Lightning</button>
    <br><br>
    <input id="powerLevel" type="number" value="0" min="0" max="4">
    <button id="setPowerLevel">Set Power Level</button>
</div>

<script type="module">
    import * as VanBikeLib from '../src/index.js'
    
    document.querySelector('#retrieveEncryptionData').addEventListener('click', async () => {
        const webService = new VanBikeLib.WebService();
        const success = await webService.authenticate(document.querySelector('#username').value, document.querySelector('#password').value);
        if(success) {
            let keyData = await webService.getKeyData();
            document.querySelector('#encryptionKey').value = keyData.encryptionKey;
            document.querySelector('#userKeyId').value = keyData.userKeyId;
        }
    });

    document.querySelector('#connect').addEventListener('click', async () => {
        const bikeProfile = new VanBikeLib.ElectrifiedSX3Profile();
        window.vanBikeService = new VanBikeLib.VanBikeService(
            bikeProfile,
            document.querySelector('#encryptionKey').value,
            document.querySelector('#userKeyId').value
        );

        await vanBikeService.connect();
        await vanBikeService.authenticate();

       /* const subscriberEntity = bikeProfile.createBluetoothSubscriberEntity((parameters) => {
            console.log(parameters);
        });*/
        const subscriberEntity = new VanBikeLib.BluetoothSubscriberEntity(bikeProfile.SERVICE_DEFENCE, bikeProfile.CHARACTERISTIC_LOCK_STATE, (buffer) => {
            console.log(buffer);
        });
        await vanBikeService.subscribe(subscriberEntity);

        //await vanBikeService.getLockState();
    });

    document.querySelector('#disconnect').addEventListener('click', async () => {
        await vanBikeService.disconnect();
        window.vanBikeService = undefined;
    });

    document.querySelector('#getFirmwareRevision').addEventListener('click', async () => {
        // Retrieve Firmware Revision
        console.log('Firmware Revision: ' + await vanBikeService.getFirmwareRevision());
    });


    document.querySelector('#moduleOn').addEventListener('click', async () => {
        // Turn on
        const moduleState = new VanBikeLib.ModuleStateEntity();
        moduleState.setState(moduleState.STATE_ON);
        await vanBikeService.setModuleState(moduleState);
    });

    document.querySelector('#unlock').addEventListener('click', async () => {
        // Unlock
        const lockState = new VanBikeLib.LockStateEntity();
        //lockState.setState(lockState.STATE_UNLOCKED);
        lockState.setState(lockState.ACTION_UNLOCK);
        await vanBikeService.setLockState(lockState);
    });

    document.querySelector('#setLightning').addEventListener('click', async () => {
        // Lightning
        const lightningState = new VanBikeLib.LightningStateEntity();
        lightningState.setState(new Uint8Array([document.querySelector('#lightning').value]));
        await vanBikeService.setLightningState(lightningState);
    });

    document.querySelector('#setPowerLevel').addEventListener('click', async () => {
        // PowerLevel
        const powerLevelState = new VanBikeLib.PowerLevelStateEntity();
        powerLevelState.setState(new Uint8Array([document.querySelector('#powerLevel').value]));
        const regionState = new VanBikeLib.RegionStateEntity();
        regionState.setState(regionState.STATE_EU);
        await vanBikeService.setPowerLevelState(powerLevelState, regionState);
    });
</script>
</body>
</html>